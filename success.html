<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zahlung erfolgreich ‚Äì BarSclusive</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0a0a0a; color:#fff; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
    .card { background:#1a1a1a; border-radius:20px; max-width:440px; width:100%; padding:40px; text-align:center; }
    .icon { font-size:60px; margin-bottom:16px; }
    h1 { font-size:22px; margin-bottom:8px; }
    p { color:#999; font-size:14px; line-height:1.6; margin-bottom:20px; }
    .spinner { display:inline-block; width:40px; height:40px; border:3px solid #333; border-top-color:#FF3366; border-radius:50%; animation:spin 0.8s linear infinite; margin:20px 0; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .btn { display:inline-block; background:#FF3366; color:#fff; padding:14px 28px; border-radius:12px; text-decoration:none; font-weight:700; font-size:15px; margin-top:16px; }
    .btn:hover { background:#e6295a; }
    .btn-ghost { display:inline-block; color:#999; padding:10px 20px; text-decoration:none; font-size:13px; margin-top:8px; }
    .error { color:#ef4444; }
  </style>
</head>
<body>

<div class="card">
  <!-- Loading State -->
  <div id="stateLoading">
    <div class="icon">üí≥</div>
    <h1>Zahlung wird best√§tigt...</h1>
    <div class="spinner"></div>
    <p>Bitte warte einen Moment. Dein Gutschein wird erstellt.</p>
  </div>

  <!-- Success State -->
  <div id="stateSuccess" style="display:none">
    <div class="icon">üéâ</div>
    <h1>Zahlung erfolgreich!</h1>
    <p>Dein Gutschein wurde erstellt und per Email gesendet.<br>Du kannst ihn auch direkt hier anzeigen:</p>
    <a class="btn" id="linkVoucher" href="#">üé´ Gutschein anzeigen</a>
    <br>
    <a class="btn-ghost" href="shop.html">‚Üê Zur√ºck zum Shop</a>
  </div>

  <!-- Error State -->
  <div id="stateError" style="display:none">
    <div class="icon">‚ö†Ô∏è</div>
    <h1 class="error">Fehler bei der Best√§tigung</h1>
    <p id="errorMsg">Die Zahlung konnte nicht best√§tigt werden.</p>
    <a class="btn-ghost" href="shop.html">‚Üê Zur√ºck zum Shop</a>
  </div>
</div>

<script>
const BACKEND_URL = 'https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbzQv_aEnFWV0TAPKyvBeuiJfQnPynUU7ptfj87x-HXJnUanh6s15V_WIXoBBTIbOp8nCQ/exec/exec';

async function confirmPayment() {
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get('session_id');

  if (!sessionId) {
    showError('Keine Session-ID gefunden. Bitte pr√ºfe deine Email f√ºr den Gutschein.');
    return;
  }

  try {
    const resp = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({
        action: 'confirmStripePayment',
        session_id: sessionId,
        site_url: window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '')
      })
    });
    const data = await resp.json();

    if (!data.success) {
      showError(data.error || 'Zahlung konnte nicht best√§tigt werden.');
      return;
    }

    // Success!
    document.getElementById('stateLoading').style.display = 'none';
    document.getElementById('stateSuccess').style.display = 'block';

    if (data.voucher_code) {
      const base = window.location.pathname.replace(/\/[^\/]*$/, '');
      document.getElementById('linkVoucher').href = base + '/voucher.html?code=' + data.voucher_code;
    }

  } catch (e) {
    showError('Verbindungsfehler. Dein Gutschein wurde trotzdem per Email gesendet.');
  }
}

function showError(msg) {
  document.getElementById('stateLoading').style.display = 'none';
  document.getElementById('stateError').style.display = 'block';
  document.getElementById('errorMsg').textContent = msg;
}

confirmPayment();
</script>
</body>
</html>
