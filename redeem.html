<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gutschein einl√∂sen ‚Äì BarSclusive</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#0a0a0a; color:#fff; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
    .card { background:#1a1a1a; border-radius:20px; max-width:440px; width:100%; padding:32px; text-align:center; border:1px solid #2a2a2a; }
    .icon { font-size:56px; margin-bottom:12px; }
    h1 { font-size:22px; margin-bottom:6px; }
    p { color:#999; font-size:14px; line-height:1.6; margin-bottom:12px; }
    .code { font-size:28px; font-weight:800; letter-spacing:4px; color:#FF3366; margin:16px 0; }
    .deal-info { background:#2a2a2a; border-radius:12px; padding:16px; margin:16px 0; text-align:left; }
    .deal-info .row { display:flex; justify-content:space-between; padding:4px 0; color:#ccc; font-size:14px; }
    .deal-info .label { color:#999; }
    .spinner { display:inline-block; width:40px; height:40px; border:3px solid #333; border-top-color:#FF3366; border-radius:50%; animation:spin .8s linear infinite; margin:20px 0; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .warn { background:#2a1a00; border:2px solid #f59e0b; border-radius:12px; padding:14px; margin:16px 0; }
    .warn p { color:#fcd34d; margin:0; font-weight:600; font-size:15px; }
    .warn small { color:#d4a040; font-size:12px; }
    .swipe-track { position:relative; height:60px; background:#2a2a2a; border-radius:30px; margin:20px 0; overflow:hidden; touch-action:none; user-select:none; }
    .swipe-fill { position:absolute; left:0; top:0; height:100%; background:linear-gradient(90deg,#FF3366,#ff6b8a); border-radius:30px; width:0; transition:width .1s; }
    .swipe-thumb { position:absolute; left:4px; top:4px; width:52px; height:52px; background:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:grab; z-index:2; transition:left .1s; }
    .swipe-thumb:active { cursor:grabbing; }
    .swipe-label { position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#999; font-size:14px; font-weight:600; letter-spacing:1px; pointer-events:none; z-index:1; }
    .success-box { background:#052e16; border:2px solid #22c55e; border-radius:12px; padding:20px; margin:16px 0; }
    .success-box h2 { color:#22c55e; font-size:20px; margin-bottom:4px; }
    .already-box { background:#1a1400; border:2px solid #f59e0b; border-radius:12px; padding:20px; margin:16px 0; }
    .already-box h2 { color:#f59e0b; font-size:20px; margin-bottom:4px; }
    .error-box { background:#2a0a0a; border:2px solid #ef4444; border-radius:12px; padding:20px; margin:16px 0; }
    .error-box h2 { color:#ef4444; margin-bottom:4px; }
  </style>
</head>
<body>

<div class="card">
  <!-- Loading -->
  <div id="stateLoading">
    <div class="icon">üîÑ</div>
    <h1>Gutschein wird geladen...</h1>
    <div class="spinner"></div>
  </div>

  <!-- Ready to redeem -->
  <div id="stateReady" style="display:none">
    <div class="icon">üéüÔ∏è</div>
    <h1>Gutschein einl√∂sen</h1>
    <div class="code" id="readyCode"></div>
    <div class="deal-info" id="dealInfo"></div>
    <div class="warn">
      <p>‚ö†Ô∏è Achtung: Nur einmal einl√∂sbar!</p>
      <small>Nach dem Wischen ist der Gutschein verbraucht und kann nicht erneut verwendet werden.</small>
    </div>
    <div class="swipe-track" id="swipeTrack">
      <div class="swipe-fill" id="swipeFill"></div>
      <div class="swipe-label">‚Üí ‚Üí Wischen zum Einl√∂sen ‚Üí ‚Üí</div>
      <div class="swipe-thumb" id="swipeThumb">üîì</div>
    </div>
    <p style="font-size:12px;color:#666">Schiebe den Regler ganz nach rechts</p>
  </div>

  <!-- Redeeming -->
  <div id="stateRedeeming" style="display:none">
    <div class="icon">‚è≥</div>
    <h1>Wird eingel√∂st...</h1>
    <div class="spinner"></div>
  </div>

  <!-- Success -->
  <div id="stateSuccess" style="display:none">
    <div class="icon">‚úÖ</div>
    <div class="success-box">
      <h2>Erfolgreich eingel√∂st!</h2>
      <p style="color:#86efac;margin:0">Der Gutschein wurde soeben eingel√∂st.</p>
    </div>
    <div class="code" id="successCode"></div>
    <div class="deal-info" id="successInfo"></div>
  </div>

  <!-- Already redeemed -->
  <div id="stateAlready" style="display:none">
    <div class="icon">‚ö†Ô∏è</div>
    <div class="already-box">
      <h2>Bereits eingel√∂st</h2>
      <p style="color:#fcd34d;margin:0">Dieser Gutschein wurde bereits verwendet.</p>
    </div>
    <div class="code" id="alreadyCode"></div>
  </div>

  <!-- Error -->
  <div id="stateError" style="display:none">
    <div class="icon">‚ùå</div>
    <div class="error-box">
      <h2>Fehler</h2>
      <p style="color:#fca5a5;margin:0" id="errorMsg"></p>
    </div>
  </div>
</div>

<script>
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbz1zkTHlVpnFgbMlscbjgGHXDRwhoAqYQeasInpWUDzn6dzC2aFC_DEykj_itklCHILRA/exec';
var _code = '';

async function loadVoucher() {
  var params = new URLSearchParams(window.location.search);
  _code = (params.get('code') || '').trim().toUpperCase();
  if (!_code) { showError('Kein Gutschein-Code angegeben.'); return; }

  try {
    var resp = await fetch(BACKEND_URL + '?action=getVoucherByCode&code=' + encodeURIComponent(_code));
    var data = await resp.json();
    if (!data.success || !data.voucher) { showError(data.error || 'Gutschein nicht gefunden.'); return; }
    var v = data.voucher;

    if (v.status === 'redeemed') {
      show('stateAlready');
      document.getElementById('alreadyCode').textContent = v.code;
      return;
    }

    document.getElementById('readyCode').textContent = v.code;
    var info = '<div class="row"><span class="label">Deal</span><span>' + v.deal_title + '</span></div>'
      + '<div class="row"><span class="label">Bar</span><span>' + v.bar_name + '</span></div>'
      + '<div class="row"><span class="label">Bezahlt</span><span>' + Number(v.price_paid).toFixed(2) + ' CHF</span></div>';
    if (v.discount_percent > 0) info += '<div class="row"><span class="label">Rabatt</span><span style="color:#FF3366;font-weight:700">' + v.discount_percent + '%</span></div>';
    if (v.min_order > 0) info += '<div class="row"><span class="label">Mindestbestellung</span><span>' + v.min_order + ' CHF</span></div>';
    document.getElementById('dealInfo').innerHTML = info;

    show('stateReady');
    initSwipe();
  } catch(e) { showError('Verbindungsfehler.'); }
}

function show(id) {
  ['stateLoading','stateReady','stateRedeeming','stateSuccess','stateAlready','stateError'].forEach(function(s) {
    document.getElementById(s).style.display = s === id ? 'block' : 'none';
  });
}

function showError(msg) {
  show('stateError');
  document.getElementById('errorMsg').textContent = msg;
}

function initSwipe() {
  var track = document.getElementById('swipeTrack');
  var thumb = document.getElementById('swipeThumb');
  var fill  = document.getElementById('swipeFill');
  var dragging = false, startX = 0, triggered = false;
  var maxX = track.offsetWidth - thumb.offsetWidth - 8;

  function start(e) {
    if (triggered) return;
    dragging = true;
    startX = (e.touches ? e.touches[0].clientX : e.clientX) - thumb.offsetLeft;
    thumb.style.transition = 'none';
    fill.style.transition = 'none';
  }
  function move(e) {
    if (!dragging || triggered) return;
    e.preventDefault();
    var cx = e.touches ? e.touches[0].clientX : e.clientX;
    var x = Math.min(Math.max(0, cx - startX), maxX);
    thumb.style.left = (x + 4) + 'px';
    fill.style.width = ((x / maxX) * 100) + '%';
    if (x >= maxX - 5) { dragging = false; triggered = true; doRedeem(); }
  }
  function end() {
    if (!dragging || triggered) return;
    dragging = false;
    thumb.style.transition = 'left .3s';
    fill.style.transition = 'width .3s';
    thumb.style.left = '4px';
    fill.style.width = '0';
  }

  thumb.addEventListener('mousedown', start);
  thumb.addEventListener('touchstart', start, { passive: true });
  window.addEventListener('mousemove', move);
  window.addEventListener('touchmove', move, { passive: false });
  window.addEventListener('mouseup', end);
  window.addEventListener('touchend', end);
}

async function doRedeem() {
  show('stateRedeeming');
  try {
    var resp = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'redeemVoucher', code: _code })
    });
    var data = await resp.json();

    if (data.success) {
      show('stateSuccess');
      document.getElementById('successCode').textContent = _code;
      document.getElementById('successInfo').innerHTML =
        '<div class="row"><span class="label">Deal</span><span>' + (data.deal_title || '-') + '</span></div>'
        + '<div class="row"><span class="label">Bar</span><span>' + (data.bar_name || '-') + '</span></div>';
    } else if (data.error && data.error.indexOf('eingel√∂st') !== -1) {
      show('stateAlready');
      document.getElementById('alreadyCode').textContent = _code;
    } else {
      showError(data.error || 'Einl√∂sung fehlgeschlagen.');
    }
  } catch(e) { showError('Verbindungsfehler.'); }
}

loadVoucher();
</script>
</body>
</html>
